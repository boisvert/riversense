<html>
<head>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
     integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
     crossorigin=""/>
	 <meta charset="utf-8">
     <title>Map</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
	<style>
	#map { 
			width:70%;
			display: flex;
            justify-content: center;
			align-items: center;
			height: 60%;
			margin-top:50px;
			margin-bottom:20px;
			margin-left:15%;
		}	
        .datetime-container {
            margin: 20px;
            text-align: left;
        }
	</style>
</head>
<body>
    <div id="navbar"></div>
        <div class="datetime-container">
            <h4 id="datetime"></h4>
        </div>
    <div  id="map"></div>
</body>
</html>
 <!--To display Time-->
     <script>
        function updateDateTime() {
            const now = new Date();
            const options = { year: 'numeric', month: 'long', day: 'numeric', hour: '2-digit', minute: '2-digit', second: '2-digit', hour12: true };
            const dateTimeString = now.toLocaleString('en-US', options);
            document.getElementById('datetime').textContent = dateTimeString;
        }

        // Update the date and time immediately when the page loads
        updateDateTime();

        // Optionally, update the date and time every second
        setInterval(updateDateTime, 1000);
    </script>

<!--Map Details Code-->
<script src="{{ url_for('static', filename='demo.js') }}"></script>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
crossorigin=""></script>
<script>
var tileLayer = L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png', {
    attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
});
	/*var tileLayer = L.tileLayer('https://gisco-services.ec.europa.eu/maps/tiles/OSMPositronComposite/EPSG3857/{z}/{x}/{y}.png',{
  maxNativeZoom: 18,
  maxZoom: 100
});*/

var wmsLayer = L.tileLayer.wms("https://image.discomap.eea.europa.eu/arcgis/services/EUHydro/EUHydro_RiverNetworkDatabase/MapServer/WMSServer", {
    version: '1.3.0',
    layers: '0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20',
    format: 'image/png',
    transparent: true,
	maxNativeZoom: 18,
    maxZoom: 100
});
        
var map = L.map('map', {
  center: [53.330392, -1.6686],
  zoom: 6,
  layers: [tileLayer] //,wmsLayer]
});

/*var marker = L.marker([53.330392, -1.6686],{title: "River Derwent(Sensor 1)\n Click for more info",
    riseOnHover: true})
.addTo(map)
.on('click', function(evt) {
      window.open("index", '_blank');
    });
var marker = L.marker([53.301465, -1.637259],{title: "River Derwent(Sensor 2)\n Click for more info",
    riseOnHover: true})
.addTo(map)
.on('click', function(evt) {
      window.open("index", '_blank');
    });*/
	var popup = L.popup();

    function addMarkers(sensors) {
            console.log('Sensors data:', sensors);  // Log the received data
            if (Array.isArray(sensors)) {
                sensors.forEach(sensor => {
                    if (sensor.status === 'active') {
                        const lat = parseFloat(sensor.lat);
                        const lng = parseFloat(sensor.long);
                        if (!isNaN(lat) && !isNaN(lng)) { // Ensure lat/lng are valid numbers
                            const marker = L.marker([lat, lng], {
                                title: `Sensor : ${sensor.sensorName} \nLocation: ${sensor.location}`,
                                riseOnHover: true
                            }).addTo(map);

                            marker.on('click', function() {
                                document.cookie = `sensorID=${sensor.sensorName}; path=/`;
                                document.cookie = `riverID=${sensor.riverID}; path=/`;
                                window.open(`panels`, '_blank');
                            });
                        } else {
                            console.error(`Invalid lat/lng for sensor ${sensor.sensorName}:`, sensor);
                        }
                    }
                });
            } else {
                console.error('Expected an array of sensors, received:', sensors);
            }
        }

        fetch('http://127.0.0.1:5000/get_sensors_for_map')
            .then(response => response.json())
            .then(data => addMarkers(data))
            .catch(error => console.error('Error fetching sensor list:', error));

// Add GeoJSON data
var riverData = L.geoJSON(riverDerwent, {
      onEachFeature: function (feature, layer) {
        if (feature.properties && feature.properties.name) {
          layer.bindPopup(feature.properties.name);
        }
      }
    }).addTo(map);

function onMapClick(e) {
    popup
        .setLatLng(e.latlng)
        .setContent("You clicked the map at " + e.latlng.toString())
        .openOn(map);
}

map.on('click', onMapClick);

</script>
<!--navbar-->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/flatpickr/4.6.13/flatpickr.min.js"></script>
<script>
    document.addEventListener("DOMContentLoaded", function() {
        fetch('/navbar')
            .then(response => {
                if (!response.ok) {
                    throw new Error('Network response was not ok ' + response.statusText);
                }
                return response.text();
            })
            .then(data => {
                document.getElementById('navbar').innerHTML = data;
            })
            .catch(error => {
                console.error('There was a problem with the fetch operation:', error);
            });
    });
</script> 